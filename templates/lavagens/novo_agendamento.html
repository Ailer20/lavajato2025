{% extends 'base/base.html' %}
{% load static %}

{% block title %}Novo Agendamento - Lava Jato 2025{% endblock %}

{% block extra_css %}
    <!-- Estilos do Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        /* Estilos para os botões de Local e Alertas */
        .alert-info-custom {
            background-color: rgba(13, 202, 240, 0.1 );
            color: #0dcaf0;
            border-left: 4px solid #0dcaf0;
            border-radius: 8px;
            padding: 1rem;
        }
        .local-btn.active {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            color: white !important;
        }
        .local-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .local-btn:not(:disabled):hover {
            background-color: rgba(59, 76, 184, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Ajustes finos para a aparência do Select2 */
        .select2-container--bootstrap-5 .select2-selection {
            background-color: var(--input-bg-color, #2a2f4a);
            border: 1px solid var(--input-border-color, #40466e);
            color: var(--text-color, #f0f0f0);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            min-height: calc(1.5em + 1rem + 2px);
            display: flex;
            align-items: center;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color, #3b4cb8);
            color: white;
            border: none;
            border-radius: 0.3rem;
            padding: 2px 8px;
            margin-top: 0.25rem;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            opacity: 0.7;
            font-size: 1.1em;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
            opacity: 1;
        }
        .select2-dropdown {
            background-color: var(--card-bg-color, #1e223d);
            border: 1px solid var(--input-border-color, #40466e);
            border-radius: 0.5rem;
        }
        .select2-results__option {
            color: var(--text-color, #f0f0f0);
            padding: 0.75rem 1rem;
        }
        .select2-results__option--highlighted {
            background-color: var(--primary-color, #3b4cb8) !important;
            color: white !important;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-search__field::placeholder {
            color: #6c757d;
        }
        .alert-info-custom {
            background-color: rgba(13, 202, 240, 0.1);
            color: #0dcaf0;
            border-left: 4px solid #0dcaf0;
            border-radius: 8px;
            padding: 1rem;
        }

        .local-btn.active {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            color: white !important;
        }

        .local-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .local-btn:not(:disabled):hover {
            background-color: rgba(59, 76, 184, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

    </style>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4">
                {# REMOVIDA a classe 'text-white' para que o título siga o tema #}
                <h1 class="mb-1">
                    <i class="fas fa-calendar-plus me-3"></i>
                    Novo Agendamento
                </h1>
                <p class="text-muted mb-0">Agende uma nova lavagem</p>
            </div>

            <!-- Formulário -->
            {# REMOVIDA a classe 'form-container' que não é mais necessária #}
            <div class="card-custom">
                <form method="POST" id="agendamentoForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Cliente -->
                        <div class="col-md-6 mb-3">
                            {# TROCADAS as classes personalizadas pela padrão 'form-label' #}
                            <label class="form-label">CLIENTE *</label>
                            <select class="form-select" name="cliente" id="cliente_select" required>
                                <option value="">Selecione o cliente</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Placa Veículo -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">PLACA VEÍCULO *</label>
                            <input type="text" 
                                   class="form-control" 
                                   name="placa_veiculo"
                                   id="placa_veiculo"
                                   placeholder="Digite a placa do veículo"
                                   maxlength="10"
                                   required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Data do Agendamento -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DATA DO AGENDAMENTO *</label>
                            <input type="date" 
                                   class="form-control" 
                                   name="data_agendamento"
                                   id="data_agendamento"
                                   min="{{ data_hoje }}"
                                   required>
                        </div>

                        <!-- Hora do Agendamento -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">HORA DO AGENDAMENTO *</label>
                            <input type="time" 
                                   class="form-control" 
                                   name="hora_agendamento"
                                   id="hora_agendamento"
                                   min="06:00"
                                   max="18:00"
                                   required>
                            <small class="text-muted">Horário de funcionamento: 6h às 18h</small>
                        </div>
                    </div>

                    <!-- Base -->
                    <div class="mb-3">
                        <label class="form-label">BASE *</label>
                        <select class="form-select" name="base" id="base_select" required>
                            <option value="">Selecione a base</option>
                            {% for base in bases %}
                                <option value="{{ base.id }}">{{ base.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Local -->
                    <div class="mb-3">
                        <label class="form-label">LOCAL *</label>
                        <div class="btn-group w-100" role="group" id="local_buttons">
                            <input type="hidden" name="local" id="local_hidden">
                            <button type="button" class="btn local-btn" data-value="1" disabled>DICK 1</button>
                            <button type="button" class="btn local-btn" data-value="2" disabled>DICK 2</button>
                            <button type="button" class="btn local-btn" data-value="3" disabled>BASES</button>
                        </div>
                        <div id="disponibilidade_status" class="mt-2" style="display: none;"></div>
                    </div>

                    <div class="row">
                        <!-- Tipo de Lavagem -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">TIPO DE LAVAGEM *</label>
                            <select class="form-select" name="tipo_lavagem" id="tipo_lavagem" required>
                                <option value="">Selecione o tipo de lavagem</option>
                                {% for tipo in tipos_lavagem %}
                                    <option value="{{ tipo.id }}" data-preco="{{ tipo.preco_base }}">
                                        {{ tipo.nome }} - R$ {{ tipo.preco_base|floatformat:2 }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Transportes/Equipamentos -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">TRANSPORTES/EQUIPAMENTOS *</label>
                            <select class="form-select" name="transporte_equipamento" id="transporte_equipamento" required>
                                <option value="">Selecione o tipo</option>
                                {% for transporte in transportes_equipamentos %}
                                    <option value="{{ transporte.id }}" data-multiplicador="{{ transporte.multiplicador_preco }}">
                                        {{ transporte.nome }}
                                        {% if transporte.multiplicador_preco != 1.0 %}(x{{ transporte.multiplicador_preco }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Duração Estimada -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DURAÇÃO ESTIMADA (MINUTOS)</label>
                            <input type="number" class="form-control" name="duracao_estimada" id="duracao_estimada" min="15" max="240" value="30">
                        </div>

                        <!-- Lavador -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">LAVADORES</label> <!-- Opcional: mudar o label para plural -->
                            <select class="form-control" name="lavadores" id="lavadores_select" multiple>                                
                                {% for lavador in lavadores %}
                                    <option value="{{ lavador.id }}">{{ lavador.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Prioridade -->
                    <div class="mb-3">
                        <label class="form-label">PRIORIDADE</label>
                        <div class="d-flex flex-wrap">
                            <input type="hidden" name="prioridade" id="prioridade_hidden" value="NORMAL">
                            <button type="button" class="prioridade-btn prioridade-baixa" data-value="BAIXA"><i class="fas fa-arrow-down me-1"></i> Baixa</button>
                            <button type="button" class="prioridade-btn prioridade-normal active" data-value="NORMAL"><i class="fas fa-minus me-1"></i> Normal</button>
                            <button type="button" class="prioridade-btn prioridade-alta" data-value="ALTA"><i class="fas fa-arrow-up me-1"></i> Alta</button>
                            <button type="button" class="prioridade-btn prioridade-urgente" data-value="URGENTE"><i class="fas fa-exclamation me-1"></i> Urgente</button>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Telefone de Contato -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">TELEFONE DE CONTATO</label>
                            <input type="tel" class="form-control" name="telefone_contato" placeholder="(11) 99999-9999">
                        </div>

                        <!-- Email de Contato -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">EMAIL DE CONTATO</label>
                            <input type="email" class="form-control" name="email_contato" placeholder="cliente@email.com">
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="mb-4">
                        <label class="form-label">OBSERVAÇÕES</label>
                        <textarea class="form-control" name="observacoes" rows="3" placeholder="Observações sobre o agendamento..."></textarea>
                    </div>

                    <!-- Valor estimado -->
                    <div class="mb-4">
                        <div class="alert alert-info-custom">
                            <h6><i class="fas fa-calculator me-2"></i>Valor Estimado</h6>
                            <div id="valor_estimado">
                                <span class="text-muted">Selecione o tipo de lavagem e equipamento para calcular</span>
                            </div>
                            <input type="hidden" name="valor_estimado" id="valor_estimado_hidden">
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{% url 'agendamentos_dashboard' %}" class="btn btn-secondary w-100">
                                <i class="fas fa-arrow-left me-2"></i>
                                Cancelar
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success-custom w-100">
                                <i class="fas fa-calendar-check me-2"></i>
                                Agendar Lavagem
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
$(document).ready(function() {
    $('#lavadores_select').select2({
        placeholder: "Selecione um ou mais lavadores",
        theme: "bootstrap-5",
        allowClear: true
    });
});

const LavadoresMultiSelect = {
    getSelected: function() {
        return $('#lavadores_select').val() || [];
    },
    getSelectedData: function() {
        return $('#lavadores_select').select2('data');
    },
    setSelected: function(values) {
        $('#lavadores_select').val(values).trigger('change');
    },
    clear: function() {
        $('#lavadores_select').val(null).trigger('change');
    },
    addOption: function(value, text, selected = false) {
        const option = new Option(text, value, selected, selected);
        $('#lavadores_select').append(option);
        if (selected) {
            $('#lavadores_select').trigger('change');
        }
    },
    removeOption: function(value) {
        $('#lavadores_select').find(`option[value="${value}"]`).remove();
        $('#lavadores_select').trigger('change');
    },
    enable: function() {
        $('#lavadores_select').prop('disabled', false);
    },

    disable: function() {
        $('#lavadores_select').prop('disabled', true);
    }
};


$(document).ready(function() {
    // Definir data mínima como hoje
    const today = new Date().toISOString().split('T')[0];
    $('#data_agendamento').val(today);
    
    // Definir hora atual
    const now = new Date();
    const currentTime = now.toTimeString().slice(0, 5);
    $('#hora_agendamento').val(currentTime);

    // Carregar locais quando base for selecionada
    $('#base_select').change(function() {
        const baseId = $(this).val();
        const localButtons = $('#local_buttons .local-btn');
        
        if (baseId) {
            // Habilitar botões de local
            localButtons.prop('disabled', false);
            
            // Limpar seleção anterior
            localButtons.removeClass('active');
            $('#local_hidden').val('');
            $('#disponibilidade_status').hide();
        } else {
            // Desabilitar botões de local
            localButtons.prop('disabled', true).removeClass('active');
            $('#local_hidden').val('');
            $('#disponibilidade_status').hide();
        }
    });

    // Seleção de local
    $('.local-btn').click(function() {
        if (!$(this).prop('disabled')) {
            $('.local-btn').removeClass('active');
            $(this).addClass('active');
            $('#local_hidden').val($(this).data('value'));
            
            // Verificar disponibilidade
            verificarDisponibilidade();
        }
    });

    // Seleção de prioridade
    $('.prioridade-btn').click(function() {
        $('.prioridade-btn').removeClass('active');
        $(this).addClass('active');
        $('#prioridade_hidden').val($(this).data('value'));
    });

    // Calcular valor estimado
    function calcularValorEstimado() {
        const tipoLavagem = $('#tipo_lavagem option:selected');
        const transporte = $('#transporte_equipamento option:selected');
        
        if (tipoLavagem.val() && transporte.val()) {
            const precoBase = parseFloat(tipoLavagem.data('preco'));
            const multiplicador = parseFloat(transporte.data('multiplicador'));
            const valorTotal = precoBase * multiplicador;
            
            $('#valor_estimado').html(`
                <strong>R$ ${valorTotal.toFixed(2)}</strong>
                <small class="d-block text-muted">
                    Base: R$ ${precoBase.toFixed(2)} × ${multiplicador} = R$ ${valorTotal.toFixed(2)}
                </small>
            `);
            
            // --- PASSO 2: ATUALIZE O JAVASCRIPT PARA PREENCHER O CAMPO ---
            $('#valor_estimado_hidden').val(valorTotal.toFixed(2));
            
            // ... (resto da sua função) ...
        } else {
            $('#valor_estimado').html('<span class="text-muted">Selecione o tipo de lavagem e equipamento para calcular</span>');
            
            // Limpe o campo escondido também
            $('#valor_estimado_hidden').val('');
        }
    }
    $('#tipo_lavagem, #transporte_equipamento').change(calcularValorEstimado);

    // Verificar disponibilidade de horário
    function verificarDisponibilidade() {
        const data = $('#data_agendamento').val();
        const hora = $('#hora_agendamento').val();
        const local = $('#local_hidden').val();
        
        if (data && hora && local) {
            $.ajax({
                url: '{% url "api_verificar_disponibilidade" %}',
                method: 'POST',
                data: JSON.stringify({
                    data_agendamento: data,
                    hora_agendamento: hora,
                    local_id: local
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    const statusDiv = $('#disponibilidade_status');
                    if (response.disponivel) {
                        statusDiv.html(`
                            <div class="disponibilidade-check disponivel">
                                <i class="fas fa-check-circle me-2"></i>
                                ${response.mensagem}
                            </div>
                        `).show();
                    } else {
                        statusDiv.html(`
                            <div class="disponibilidade-check indisponivel">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${response.mensagem}
                            </div>
                        `).show();
                    }
                },
                error: function() {
                    $('#disponibilidade_status').hide();
                }
            });
        }
    }

    $('#data_agendamento, #hora_agendamento').change(verificarDisponibilidade);

    // Formatação de telefone
    $('input[name="telefone_contato"]').on('input', function() {
        let value = $(this).val().replace(/\D/g, '');
        if (value.length >= 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (value.length >= 7) {
            value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (value.length >= 3) {
            value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
        }
        $(this).val(value);
    });

    // Formatação de placa
    $('#placa_veiculo').on('input', function() {
        $(this).val($(this).val().toUpperCase());
    });
});
</script>
{% endblock %}

